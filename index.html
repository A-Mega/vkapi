<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>VK API</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <button id="load">Friends</button>
    <button id="get-dialogs">Dialogs</button>
    <button id="newsfeed">Newsfeed</button>
    <button id="test1">Set</button>
    <button id="test2">Get</button>
    <button id="test3">Test</button>
    <div class="wrapper">
        <ul id="list"></ul> <!--??? -->
        <div class="detail" style="display: none;">
            <img src="">
            <h3></h3>
            <ul>

            </ul>
            <textarea></textarea>
            <button id="send-message">Send message</button>
        </div>
    </div>

    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="vk.js"></script>
    <script src="storage.js"></script>
    <script src="utils.js"></script>
    <script>
        $('#load').on('click', loadFriends);
        $('#send-message').on('click', sendMessage);
        $('#get-dialogs').on('click', getDialogs);
        $('#newsfeed').on('click', getNewsfeed);
        $('#test1').on('click', storageSet);
        $('#test2').on('click', storageGet);
        $('#test3').on('click', getUserNameById);

        $(document).on('click', '.open-history', function (event) {
            var id = +$(event.target).data('id');
            getHistory(id)
        });

        $(document).on('click', '.open-detail', function (event) { //делегируем document'у
            event.preventDefault();
            var id = +$(event.target).data('id'); //$().attr('data-id');
            sendRequest('users.get',
                { user_ids: id, fields: 'sex,bdate,country,timezone,photo_big' },
                drawDetailFriend
            );
        });
/////////////////////////////////////////////////////////////////
        function getNewsfeed() {
            sendRequest('newsfeed.get', { filters: 'photo' }, function (data) {
                drawNewsfeed(data.response.items);
               // drawNewsfeed(data.response.items[0].photos.items[0].photo_130);
            });
        }

        function drawNewsfeed(feeds) {
            //console.log(feeds);
            $('.detail').hide(); //приходится каждый раз прятать

            var html = '';
            for (var i = 0; i < feeds.length; i++) {
                var f = feeds[i].photos.items;
                
                html +='<p>';
                    html += '<p>Подборка фото №' + (i+1) + '</p>'
                    f.forEach(element => {
                        html += '<img src="' + element.photo_130 + '" />'
                        //html += '<a href="#"><img src="' + element.photo_130 + '" /></a>'
                    });
                    /* for (var j = 0; j < f.length; j++) {
                        html +=
                        '<img src="' + f[j].photo_130 + '">'                      
                    } */
                html += '</p>';
            }
            console.log(html);
            $('ul').html(html);
        }

        /* $(document).ready(function () {
        $('ul p').click(function () {
            var o=$(this).parent();
            var url=o.find('img').attr('src');
            var html='<a href="#" class="clone"><img src="'+url+'" /></a>'
            o.append(html);
            o=o.find('.clone');
            o.animate({width:'200%',height:'200%'});
            o.click(function () {
                $(this).remove();
            });
        });
    }); */
///////////////////////////////////////////////////////////
//console.log(data.response[0].first_name + ' ' + data.response[0].last_name);
        function getUserNameById(user_id) {
            var promise = new Promise((resolve, reject) => {
                /* sendRequest('users.get',
                    { user_id: user_id, fields: 'sex,bdate,country,timezone,photo_big' },
                    function(data) {data},
                    false) */
                /* sendRequestXHR('users.get',
                    { user_id: user_id, fields: 'sex,bdate,country,timezone,photo_big' }) */
                
            });

             promise.then(
                        data => {
                        // первая функция-обработчик - запустится при вызове resolve
                        console.log(data);; // result - аргумент resolve
                        },
                        error => {
                        // вторая функция - запустится при вызове reject
                        console.log("Rejected: " + error); // error - аргумент reject
                        }
                    );
        }
/////////////////////////////////////////////////////////////////
        function loadFriends() {
            //console.log(getUserNameById()); //выводит undefined !!!!!!!!!!!!!!!!!!!!!!

            $('.detail').hide(); //приходится каждый раз прятать

            sendRequest('friends.search', { count: 300, fields: 'photo_100, online' }, function (data) {
                console.log(data.response);
                drawFriends(data.response.items);
            });
            
        }

        function drawFriends(friends) {

            var html = '';
            for (var i = 0; i < friends.length; i++) {
                var f = friends[i];
                var online = f.online ? 'Online' : 'Offline';

                //if(!f.id) console.log('user_id undefined: ' + f.id);
                html +=
                    '<li>'
                    //+ '<a target="_blank" href="https://vk.com/id' + f.id + '">'
                    + '<a href="#">'
                    + '<img src="' + f.photo_100 + '" />'
                    + '<div>'
                    + '<h4>' + f.first_name + ' ' + f.last_name + '</h4>'
                    + '<p>' + online + '</p>'
                    + '<button data-id="' + f.id + '" class="open-detail">Open</button>'
                    + '</div>'
                    + '</a>'
                    + '</li>';
            }

            $('ul').html(html);

        }

        function drawDetailFriend(data) {
            var user = data.response[0];
            var $detail = $('.detail');

            var sex = user.sex;
            switch (sex) {
                case 1: sex = 'женский'; break;
                case 2: sex = 'мужской'; break;
                case 0: sex = 'пол не указан'; break;
                default: sex = 'ошибка определения пола';
            }

            var ulHtml = '<il>' + user.country.title + '</il>'
                + ' <il>' + sex + '</il>'
                + ' <il>' + user.id + '</il>';

            $detail.find('img').attr('src', user.photo_big);
            $detail.find('h3').text(user.first_name + ' ' + user.last_name);
            $detail.find('ul').html(ulHtml);
            $detail.find('button').attr('data-id', user.id);
            $detail.show(400);
        }

        function sendMessage(event) {
            var id = +$(event.target).attr('data-id');
            var value = $('textarea').val();

            if (!value) {
                alert('Empty message!');
                return;
            }

            sendRequest('messages.send', { user_id: id, message: value }, function () {
                console.log('Sended');
            });
        }

        ////////////////////////////////////////
        function getDialogs() {
            $('.detail').hide(); //приходится каждый раз прятать

            sendRequest('messages.getDialogs', { count: 10 }, function (data) {
                //console.log(data.response.items);
                drawDialogs(data.response.items);
            });
        }

        function drawDialogs(dialogs) {
            var html = '';

            for (var i = 0; i < dialogs.length; i++) {
                var d = dialogs[i];
                if (!d.message.body) d.message.body = 'Attention! Message can not be displayed!';
                var date = d.message.date;

                html +=
                    '<li>'
                    + '<div>' + '<h4>' + 'Sender: ' + getUserNameById(d.message.user_id) + ' ' + unixTimeToDateHtml(date) + '</h4>' + '</div>'
                    + '<div>' + '<h4>' + d.message.body + '</h4>' + '</div>'
                    + '<button data-id="' + d.message.user_id + '" class="open-history">Open history</button>'
                    + '</a>'
                    + '</li>';
            }

            $('ul').html(html);

        }

        //////////////////////////////////////////////////////////////////////////////////
        function getHistory(id = 3684560) {
            sendRequest('messages.getHistory', { count: 10, user_id: id, offset: 5 }, function (data) {
                drawHistory(data.response.items);
                //console.log(data.response);
            });
            
        }

        function drawHistory(history) {

            var html = '';
            for (var i = 0; i < history.length; i++) {
                var d = history[i];
                var date = d.date;

/*             sendRequest('users.get',
                { user_ids: d.user_id },
                getNameByUserId
            ); */

            //console.log(getNameByUserId(d.user_id));

                html +=
                    '<li>'
                    + '<div>' + '<h4>' + 'Sender: ' + d.user_id + ' ' + unixTimeToDateHtml(date) + '</h4>' + '</div>'
                    + '<div>' + '<h4>' + d.body + '</h4>' + '</div>'
                    + '</a>'
                    + '</li>';
            }

            $('ul').html(html);

        }

/*         function srUser(users) {
            sendRequest('users.get',
                { user_ids: users },
                getNameByUserId
            );
        } */

/*         function getNameByUserId(users) {
            https://api.vk.com/method/users.get?fields=photo_100%2C%20online&access_token=640b480d139fe0063e371446c8fe70c3ac740bce67ec9c7e8bb7eddb806ba926d3f72c7dbf026be7db4ac&v=5.52
            var user = users.response[0];
            //console.log(user.first_name);
            return user.first_name;
        } */

////////////////////////////////////////////////////////////////////////////////////////
        function getChat() {
            sendRequest('messages.getChat', { chat_id: 1 }, function (data) {
                console.log(data);
                //drawHistory(data.response);
            });
        }

    </script>
</body>

</html>